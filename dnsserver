#!/usr/bin/env python3
import argparse
import socket
from dnslib import DNSRecord, DNSHeader, QTYPE, A, RR

DNS_SERVER = "cdn-dns.5700.network"
HTTP_SERVER = "cdn-http4.5700.network"
REPLICA = "1.1.1.1"
CDN_NAME = "cs5700cdn.example.com"
PORT = None

def handle_query(query):
    
    response = query.reply()
    qtype = QTYPE[query.q.qtype]
    query_name = str(query.q.qname).rstrip('.')
    print(query_name)

    if qtype == "A" and query_name == CDN_NAME:
        print("mark3")
        answer = RR(query.q.qname, QTYPE.A, rdata=A(REPLICA), ttl=3600)
        response.add_answer(answer)

    return response

def main():

    global REPLICA, PORT
    parser = argparse.ArgumentParser()
    parser.add_argument('-p', '--port', required=True, help="Port number to bind the DNS server")
    parser.add_argument('-n', '--name', required=True, help="CDN-specific name that your server translates to an IP")
    args = parser.parse_args()

    PORT = int(args.port)
    REPLICA = socket.gethostbyname(HTTP_SERVER)

    print("Replica: ")
    print(REPLICA)

    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    sock.bind(("", PORT))

    while True:
        print("mark1")
        data, addr = sock.recvfrom(1024)
        print("mark2")
        query = DNSRecord.parse(data)
        response = handle_query(query)
        sock.sendto(response.pack(), addr)


if __name__ == "__main__":
    main()

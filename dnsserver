#!/usr/bin/env python3
import argparse
import socket
from dnslib import DNSRecord, DNSHeader, QTYPE, A, RR
import subprocess
import logging
import time


class ReplicaManager:
    def __init__(self, replica_servers):
        self.replica_servers = replica_servers
        self.client_replica_map = {}

    def measure_latency(self, server, client_ip, latency_port = 20022):
        # Connect to the HTTP server's latency measurement port
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as sock:
            sock.connect((server, latency_port))
            sock.sendall(client_ip.encode())
            latency = float(sock.recv(1024).decode())
            return latency

    def get_best_replica(self, client_ip):
        if client_ip not in self.client_replica_map:
            latencies = {}
            for server in self.replica_servers:
                try:
                    latency = self.measure_latency(server, client_ip)
                    latencies[server] = latency
                    self.save_scamper_output(server, latency)
                except Exception as e:
                    print(f"Error measuring latency for server {server}: {e}")
                    continue
            
            best_replica = min(latencies, key=latencies.get)
            self.client_replica_map[client_ip] = best_replica

        return self.client_replica_map[client_ip]

    def save_scamper_output(self, server, output):
        with open("all_servers_scamper.log", 'a') as log_file:
            log_file.write(f"Server: {server}\n")
            log_file.write(f"Timestamp: {time.strftime('%Y-%m-%d %H:%M:%S')}\n")
            log_file.write(output)
            log_file.write("\n")


class DNSServer:
    def __init__(self, port, cdn_name, replica_manager):
        self.port = port
        self.cdn_name = cdn_name
        self.replica_manager = replica_manager
        self.sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        self.sock.bind(("", self.port))

    def handle_query(self, query, client_addr):
        logging.debug(f"Received query from {client_addr}: {query}")
        response = query.reply()
        qtype = QTYPE[query.q.qtype]
        query_name = str(query.q.qname).rstrip('.')
        root_server_ip = "198.41.0.4"

        if qtype == "A" and query_name.startswith(self.cdn_name):
            client_ip = client_addr[0]
            best_replica = self.replica_manager.get_best_replica(client_ip)
            best_replica_ip = socket.gethostbyname(best_replica)
            answer = RR(query.q.qname, QTYPE.A, rdata=A(best_replica_ip), ttl=3600)
        else:
            answer = RR(query.q.qname, QTYPE.A, rdata=A(root_server_ip), ttl=3600)

        response.add_answer(answer)
        return response

    def run(self):
        while True:
            data, addr = self.sock.recvfrom(1024)
            query = DNSRecord.parse(data)
            response = self.handle_query(query, addr)
            self.sock.sendto(response.pack(), addr)

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('-p', '--port', required=True, help="Port number to bind the DNS server")
    parser.add_argument('-n', '--name', required=True, help="CDN-specific name that your server translates to an IP")
    args = parser.parse_args()

    port = int(args.port)
    cdn_name = args.name

    replica_servers =[
        "cdn-http1.5700.network",
        "cdn-http2.5700.network",
        "cdn-http3.5700.network",
        "cdn-http4.5700.network",
        "cdn-http5.5700.network",
        "cdn-http6.5700.network",
        "cdn-http7.5700.network",
    ]

    replica_manager = ReplicaManager(replica_servers)
    dns_server = DNSServer(port, cdn_name, replica_manager)
    dns_server.run()

if __name__ == "__main__":
    main()